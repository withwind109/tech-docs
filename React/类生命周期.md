## 类组件周期

React v16.0 后的生命周期

| 生命周期阶段               | 方法名                                               | 调用时机                                | 用途                           |
| -------------------------- | ---------------------------------------------------- | --------------------------------------- | ------------------------------ |
| 挂载（Mounting）           | `constructor(props)`                                 | 创建组件时                              | 初始化 state，绑定事件处理方法 |
|                            | `static getDerivedStateFromProps(props, state)`      | 调用 render 方法之前以及接收新 props 时 | 更新 state 或返回 null         |
|                            | `render()`                                           | 挂载和更新时                            | 返回 React 元素                |
|                            | `componentDidMount()`                                | 组件挂载到 DOM 后                       | 执行网络请求、DOM 操作等       |
| 更新（Updating）           | `static getDerivedStateFromProps(props, state)`      | 接收新 props 时                         | 更新 state 或返回 null         |
|                            | `shouldComponentUpdate(nextProps, nextState)`        | 接收到新的 props 或 state 之前          | 决定是否重新渲染               |
|                            | `render()`                                           | 更新时                                  | 返回 React 元素                |
|                            | `getSnapshotBeforeUpdate(prevProps, prevState)`      | 最近一次渲染输出之前                    | 捕获 DOM 信息（如滚动位置）    |
|                            | `componentDidUpdate(prevProps, prevState, snapshot)` | 更新后                                  | 执行网络请求、DOM 操作等       |
| 卸载（Unmounting）         | `componentWillUnmount()`                             | 组件卸载前                              | 清理操作（如取消网络请求）     |
| 错误处理（Error Handling） | `static getDerivedStateFromError(error)`             | 后代组件抛出错误时                      | 渲染备用 UI                    |
|                            | `componentDidCatch(error, info)`                     | 后代组件抛出错误后                      | 记录错误信息                   |

请注意，这个表格是基于 React 16 版本的生命周期方法。在 React 17 和 React 18 中，生命周期方法可能有所不同，特别是在并发模式下。因此，如果你使用的是更新的 React 版本，请参考相应版本的官方文档。

### getDerivedStateFromProps 新增静态方法

它的作用是在组件实例化后和接收新的 props 之前，将状态更新为依赖于 props 的值。这个方法的引入是为了替代 `componentWillReceiveProps`，因为后者可能会导致一些 bug 和不一致的行为，特别是在异步渲染的情况下。

`getDerivedStateFromProps` 方法的使用示例如下：

```javascript
class MyComponent extends React.Component {
    constructor(props) {
        super(props);
        this.state = {
            derivedData: computeDerivedState(props),
        };
    }

    static getDerivedStateFromProps(nextProps, prevState) {
        if (nextProps.someValue !== prevState.someValue) {
            // 当props.someValue变化时，更新state.derivedData
            return {
                derivedData: computeDerivedState(nextProps),
                someValue: nextProps.someValue,
            };
        }

        // 返回 null 表示无需更新state
        return null;
    }

    render() {
        // ...
    }
}

function computeDerivedState(props) {
    // 根据props计算新的state值
    return props.someValue * 2;
}
```

在这个例子中，每当 `props.someValue` 发生变化时，`getDerivedStateFromProps` 方法就会计算新的 `state.derivedData`。如果 `props.someValue` 没有变化，则不需要更新状态，因此返回 `null`。

## getSnapshotBeforeUpdate 生命周期方法

它在最新的渲染输出被提交到 DOM 之前被调用，使得组件能够在发生可能的 DOM 变化之前捕获一些信息（例如滚动位置）。这个方法的引入是为了替代 `componentWillUpdate`，因为后者在新的“异步渲染”模式下可能会被调用多次，而 `getSnapshotBeforeUpdate` 保证只在渲染输出提交到 DOM 前被调用一次。

`getSnapshotBeforeUpdate` 方法的使用示例如下：

```javascript
class MyComponent extends React.Component {
    // ...

    getSnapshotBeforeUpdate(prevProps, prevState) {
        // 捕获更新前的某些信息，例如滚动位置
        if (prevProps.list.length < this.props.list.length) {
            const list = this.listRef.current;
            return list.scrollHeight - list.scrollTop;
        }
        return null;
    }

    componentDidUpdate(prevProps, prevState, snapshot) {
        // 如果snapshot不为null，说明之前捕获了一些信息
        if (snapshot !== null) {
            const list = this.listRef.current;
            list.scrollTop = list.scrollHeight - snapshot;
        }
    }

    render() {
        return <div ref={this.listRef}>{/* ... */}</div>;
    }
}
```

在这个例子中，`getSnapshotBeforeUpdate` 被用来捕获更新前的列表滚动位置，以便在更新后可以将滚动位置调整到合适的位置，保持用户的滚动位置不变。如果列表长度没有变化，则返回 `null`，表示没有必要处理滚动位置。然后在 `componentDidUpdate` 中，如果 `snapshot` 不为 `null`，就使用它来更新滚动位置。

## 被删除的生命周期:

在 React v16.3 中，以下生命周期方法被认为是不安全的，并且在未来的版本中将被废弃：

-   `componentWillMount`
-   `componentWillReceiveProps`
-   `componentWillUpdate`

这些方法被认为是不安全的，因为它们可能会导致代码在 React 的异步渲染模式下出现问题。异步渲染意味着 React 可能会开始一个工作，然后在完成之前中断它，稍后再回来继续进行。这些生命周期方法可能会在一个更新过程中被多次调用，这可能会导致不一致的渲染和其他问题。

为了替代这些不安全的生命周期方法，React 引入了新的生命周期方法：

-   `static getDerivedStateFromProps`：用于替代 `componentWillReceiveProps`，用于在组件接收到新的 props 时更新 state。
-   `getSnapshotBeforeUpdate`：用于替代 `componentWillUpdate`，用于在 DOM 更新之前捕获一些信息（如滚动位置）。

在 React v17 中，这些不安全的方法仍然可以使用，但是它们的名字前会加上 `UNSAFE_` 前缀（例如 `UNSAFE_componentWillMount`），以表明它们的不安全性。在未来的 React 版本中，这些方法最终将被完全移除。
