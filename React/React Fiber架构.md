React Fiber 是 React 16 中引入的新的协调引擎或重新实现的核心算法。它的主要目标是增强 React 在渲染大型应用程序时的性能，特别是在动画、布局和手势等领域。Fiber 架构的核心在于能够将渲染工作分割成小块并且可以管理任务的优先级，暂停和恢复工作，以及复用之前的工作。

## 概念

以下是 React Fiber 架构的一些关键特性和组成部分：

### 1. 协调算法的重写

Fiber 架构彻底重写了 React 的协调算法。协调是 React 用来比较新旧虚拟 DOM 树，找出变化部分并更新 DOM 的过程。Fiber 将这个过程变成了可中断的任务，这样就可以根据任务的优先级决定是否中断当前工作，以便执行更重要的工作。

### 2. Fiber 节点

在 Fiber 架构中，每个 React 元素都对应一个 Fiber 节点，这是一个轻量级的对象。Fiber 节点构成了一个 Fiber 树，它镜像了 React 组件树的结构。每个 Fiber 节点都包含了组件的类型、对应的 DOM 节点、子 Fiber 节点、兄弟 Fiber 节点等信息。

### 3. 双缓冲技术（Double Buffering）

React Fiber 使用了双缓冲技术，即维护两棵 Fiber 树。一棵是当前在屏幕上显示的当前树（current tree），另一棵是正在内存中构建的工作树（work-in-progress tree）。这种方法允许 React 在内存中构建新的树，而不会影响到当前显示的树，直到新树准备好一次性替换。

### 4. 任务分割与调度

Fiber 架构允许 React 将渲染任务分割成多个小任务，并根据需要在主线程上执行这些任务。这样做的好处是，如果有紧急任务（如用户输入），React 可以中断正在进行的渲染任务，先处理紧急任务，然后再回到之前的渲染任务继续。

### 5. 优先级调度

Fiber 引入了任务优先级的概念。不同类型的更新可以有不同的优先级，例如动画或用户交互可能比数据更新具有更高的优先级。React 可以根据这些优先级来决定哪些任务应该先执行。

### 6. 效果列表（Effect List）

为了优化生命周期方法的执行，Fiber 在完成渲染工作后会生成一个 effect list，这是一个包含所有需要处理副作用（如 DOM 更新、调用生命周期方法等）的 Fiber 节点的列表。React 会按照这个列表顺序执行副作用，确保正确。

## 主要特性

React Fiber 架构的实现为 React 开发带来了以下几个主要特性：

1. **增量渲染（Incremental Rendering）**：能够将渲染任务拆分成小块执行，这样即使在大型应用中也不会阻塞主线程，提高了应用的响应能力。

2. **任务暂停、中断和恢复**：React 可以根据任务的优先级暂停正在进行的工作，处理更重要的任务（如用户输入），然后再恢复之前的工作。

3. **优先级调度**：React 可以为不同的更新分配优先级，确保高优先级的更新（如动画）可以快速完成，而不被低优先级的任务（如数据同步）阻塞。

4. **并发模式（Concurrent Mode）**：这是一个实验性的特性，它允许 React 在后台准备 UI 更新，直到数据加载完成并且没有其他高优先级的任务时才进行更新。

5. **新的生命周期方法**：为了更好地适应 Fiber 架构，React 引入了新的生命周期方法，如`getDerivedStateFromProps`和`getSnapshotBeforeUpdate`。

6. **更好的错误处理**：引入了错误边界（Error Boundaries），允许开发者更好地捕获子组件树中的 JavaScript 错误，防止整个应用崩溃。

7. **Hooks API**：虽然 Hooks 不是由 Fiber 直接引入的，但 Fiber 架构为 Hooks 的实现提供了基础。Hooks 允许你在不编写类组件的情况下使用 state 和其他 React 特性。

8. **更平滑的动画和交互体验**：由于 Fiber 能够打断和重新开始工作，它可以确保应用的动画和交互保持流畅，即使在复杂更新中也不会出现卡顿。

9. **更好的可测试性和可维护性**：Fiber 架构使得 React 的内部机制更加模块化，这使得代码更容易测试和维护。

10. **Fragment 和 Portals**：虽然这些特性并非直接由 Fiber 引入，但 Fiber 架构使得这些 API 的实现更加高效。Fragment 允许组件返回多个元素，而 Portals 允许将子节点渲染到存在于父组件 DOM 层次结构之外的 DOM 节点。

Fiber 架构的引入为 React 的未来发展打下了坚实的基础，使得 React 能够更好地处理 UI 的动态性和复杂性，同时提供了更加强大和灵活的开发体验。

是实现了一个基于优先级和 requestIdleCallback(执行的前提条件是当前浏览器处于空闲状态) 的一个循环 任务调度 算法, 他在渲染虚拟 DOM、 diff 阶段将任务拆分为多个小任务、这样的话就可以随时进行中止和恢复、同时又根据每个任务的优先级来执行任务

Fiber 是把 render/update 分片, 拆解成多个小任务来执行, 每次只检查树上部分节点, 做完此部分后, 若当前一帧 (16ms) 内还有足够的时间就继续做下一个小任务, 时间不够就停止操作, 等主线程空闲时再恢复

Fiber 是根据一个 fiber 节点 (VDOM 节点) 进行来拆分, 以 fiber node 为一个任务单元, 一个组件实例都是一个任务单元, 任务循环中, 每处理完一个 fiber node, 可以中断/挂起/恢复

不同的任务分配不同的优先级, Fiber 根据任务的优先级来动态调整任务调度, 先做高优先级的任务

-   Immediate: 最高优先级, 会马上执行的不能中断
-   UserBlocking: 这一般是用户交互的结果, 需要及时反馈
-   Normal: 普通等级的, 比如网络请求等不需要用户立即感受到变化的
-   Low: 低优先级的, 这种任务可以延后, 但最后始终是要执行的
-   Idle: 最低等级的任务, 可以被无限延迟的, 比如 console.log()
