# Dart的空安全

是Dart语言在2.12版本中引入的一项重要特性，它的目的是减少由空引用（`null`）引起的错误。在许多编程语言中，空引用错误都是常见的错误来源，因为变量可能未被初始化就被访问，或者在运行时变成了意料之外的空值。Dart 通过空安全特性增强了类型系统，使得这类错误可以在编译阶段被检测出来，而非等到运行时才发生。

## 空安全引入了以下几个重要的概念：

### 不可空类型（Non-Nullable Types）

不可空类型是那些被声明了而且不能赋值为`null`的变量。在Dart 2.12及之后的版本中，基础类型（如`int`、`double`、`String`等）默认为不可空类型。如果你尝试给这些类型的变量赋值为`null`，你会在编译时收到错误。

```dart
int a = 10; // 正确：a是一个非空的整型变量。
String name = 'Dart'; // 正确：name是一个非空的字符串变量。
int b; // 错误：非空的整型变量b必须在声明时初始化。
b = null; // 错误：给非空的整型变量b赋值为null。
```
在上面的例子中，注意到不可空类型的变量在声明时必须被初始化，而且不能被赋值为`null`。

### 可空类型（Nullable Types）

可空类型是指那些被声明了，并且可以赋值为`null`的变量。在类型名称后加上`?`来声明一个可空类型。这就意味着这个变量可以持有一个该类型的值或者`null`。

```dart
int? a; // 正确：a是一个可空的整型变量，它可以为null。
a = null; // 正确：可以给可空类型的变量赋值为null。
String? name; // 正确：name是一个可空的字符串变量。
name = 'Dart'; // 正确：可空类型的变量也可以赋值成一个非空的值。
```

在上面的例子中，可空类型的变量在声明时不需要立即初始化，可以后续被赋值为`null`或者其他有效值。

### 哪些是可空类型，哪些不是可空类型：
- 所有的基本数据类型包括`int`、`double`、`String`、`bool`等，在没有加`?`时都是不可空类型。
- 当你在任何类型名称后面加上`?`，它就成为了可空类型，如`int?`、`double?`、`String?`、`bool?`等。
- 集合类型如`List`、`Set`、`Map`也同样，没加`?`是不可空类型，加了`?`是可空类型。例如, `List<String>`是不能含有`null`的字符串列表，但`List<String>?`可以是`null`，且`List<String?>`是一个可以含有`null`的字符串列表。

在处理可空类型时，需要格外小心，确保在使用变量之前对`null`值进行了适当的处理。Dart提供了多种操作符和语法结构来帮助管理`null`值，例如`??`、`?.`和`late`关键字等。 

## ?(可空类型)

dart 2.12 及之后的版本中，引入了空安全（null safety），这意味着你必须明确地指出一个变量是否能被赋值为 `null`。这是空安全特性的一部分，它有助于防止运行时出现空引用错误，因为编码时你需要显式地处理可能为 `null` 的情况。例如，当你使用 `pageController` 变量时，你必须确保它不是 `null`，或者你必须与其它代码对它的可能为 `null` 的情况进行处理。

```dart
// 重点，pageController可以被赋值为 `null`。如果没有 `?`，就无法被赋值为 `null`，如果企图这么做，编译时将会报错。
PageController? pageController0; 
PageController? pageController1; 

void myFunction() {
    // 以下代码行报错
    // The method 'jumpTo' can't be unconditionally invoked because the receiver can be 'null'.
    // Try making the call conditional (using '?.') or adding a null check to the target ('!').
    controller0.jumpTo(0); 

  // 在这里，我们必须检查 pageController 是否为 null
  if (pageController != null) {
    // pageController 已经被初始化，可以通过x!.的方式来安全使用
    pageController!.jumpTo(0);
  } else {
    // 如果 pageController 是 null，则需要处理此情形
    // 比如：初始化 pageController 或给出提示等
  }
}
```

## !非空断言操作符（Null Assertion Operator）

 在启用空安全的Dart代码中，如果你有一个可空类型的变量（例如 `int?`），它的值可能是 `null` 或者一个整数。如果你确定这个变量在某个上下文中一定不为 `null`，你可以使用感叹号 `!` 来断言这个变量此时非空，这样就可以作为非空类型使用。这称为非空断言操作符。

```dart
PageController? controller;
controller = PageController();
controller!.jumpToPage(0); // 非空断言，因为我们知道此时它不是null
```

如果你错误地使用了 `!` 而变量的值实际上是 `null`，运行时会抛出一个异常。

## ?.条件成员访问操作符（空感知调用

它允许你在对象不为 null 时调用它的成员（如方法、属性等）。如果对象为 null，它将不执行任何操作，并且整个表达式的结果也是 null。

```dart
controller?.jumpToPage(0);
```

`controller` 是一个可能为 null 的对象, `?.` 确保只有在 `controller` 不为 null 的时候才会尝试调用 `jumpToPage()` 方法。


## ??空合并运算（null coalescing）

其作用是当表达式的值为 `null` 时提供一个默认值。这在处理可能为 null 的值时可以非常有用，它可以帮助你优雅地设置后备值（fallback value）或默认值。

```dart
var value = possibleNullValue ?? defaultValue;
```

如果 `possibleNullValue` 不是 `null`，`value` 将被赋为 `possibleNullValue` 的值。如果 `possibleNullValue` 是 `null`，那么 `value` 将被赋为后面的 `defaultValue`。

```dart
String? userComment; // 这个变量可能是 null
String message = userComment ?? 'No comment provided'; // 如果 userComment 是 null，则使用默认字符串

final bool? haveFilter;
if (!(widget.haveFilter ?? false)) { // widget.haveFilter无论是否有值，都会返回一个bool值
  // 内部代码逻辑
}
```

双问号操作符 `??` 是处理可能为空的变量时增强代码可读性和简洁性的一个好方法，尤其是在空安全的Dart代码中。它防止了写过多的条件语句来检查 `null` 值，并且提供了一种流畅的方式来指定默认值。 

## ??=赋值运算符

用于在变量当前为 `null` 时，将该变量赋值为某个默认值。如果该变量已经有一个非 `null` 的值，则不进行任何操作，保留原有的值。

```dart
// 如果 `variable` 为 `null`，则将其值设置为 `defaultValue`；如果 `variable` 已经有值（且不为 `null`），则保留其原有的值。
variable ??= defaultValue;

String? greeting;
// 假设我们希望在 greeting 为 null 的情况下为它提供一个默认的问候语
greeting ??= 'Hello';
print(greeting); // 输出: Hello

// 假设现在 greeting 已经有一个非 null 的值
greeting = 'Hi';
greeting ??= 'Hello';
print(greeting); // 输出: Hi（因为 greeting 已经有值，所以不会被赋予新值）
```

这个运算符对于为变量提供默认值或者确保某个变量不为 `null` 在编写 Dart 代码时特别有用，特别是在处理可能为 `null` 的可空类型变量时。 


